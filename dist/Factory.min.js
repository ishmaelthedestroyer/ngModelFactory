angular.module("Factory",["EventEmitter","Endpoint","Util"]).service("Factory",["$log","$q","Model","Endpoint","EventEmitter","Util",function(a,b,c,d,e,f){var g=function(a,b){if(!(this instanceof g))return new g(a,b);e.call(this);var c=this,d={TAG:"Factory::",endpoints:{perPage:20}};return c.store={},c.Model=a,c.config=f.extend(d,b),c.Model._$init(b),c};return f.inherits(g,e),g.prototype._$dump=function(){var a=this,b=[];for(var c in a.store)b.push(a.store[c]);return b},g.prototype._$wrap=function(a){var b,c=this;if(a._id&&c.store[a._id]){var d={};b=c.store[a._id];for(var e in a)a.hasOwnProperty(e)&&(d[e]=angular.copy(c[e]),b[e]=a[e]);c.emit("$update",b,d),c.store[a._id].emit("$update",b,d)}else b=c.Model.apply(this,arguments),c._$registerListeners(b),c.store[b._id]=b;return b},g.prototype._$registerListeners=function(b){var c=this;return b.on("$update",function(d,e){a.debug(c.config.TAG+"registerEvents",d,e),d._id!==e._id&&(a.debug(c.config.TAG+"registerEvents","_id updated."),delete c.store[e._id],c.store[b._id]=b),c.emit("$update",b,e)}),b.on("$delete",function(b){a.debug(c.config.TAG+"registerEvents","Model deleted.",b),delete c.store[b._id],c.emit("$delete",b)}),c},g.prototype.$create=function(){var a=this,b=a.Model.apply(this,arguments);return b._$isLocal=!0,a.store[b._id]=b,a._$registerListeners(a.store[b._id]),a.emit("$create",b),b},g.prototype.$find=function(a,c,d){var e=this,f=b.defer();if(!d)for(var g in e.store)if(g===a)return f.resolve(e.store[g]),f.promise;return e.Model._$request("find",a,null,null,c||null,d).then(function(a){var b=e._$wrap(a);f.resolve(b),e.emit("$find",b)})["catch"](function(a){f.reject(a)}),f.promise},g.prototype.$list=function(a,c,d,e){var f=this,g=b.defer();return f.Model._$request("list",null,null,d||null,e).then(function(b){var e=[];angular.forEach(b,function(a){e.push(f._$wrap(a))}),g.resolve(e),f.emit("$list",e,a,c,d)})["catch"](function(a){g.reject(a)}),g.promise},g.prototype.$query=function(){var a=b.defer();return a.promise},g.prototype.$querySync=function(a){return a&&Object.keys(a).length?this._$dump().reduce(function(b,c){for(var d in a)if(a.hasOwnProperty(d))switch(typeof a[d]){case"function":if(!a[d](c[d],c))return b;break;case"boolean":if(a[d]!==c[d])return b;break;case"string":if(a[d]!==c[d])return b;break;case"object":if(a[d]!==c[d])return b;break;default:return b}return b.push(c),b},[]):this._$dump()},g.prototype.$map=function(){var a=b.defer();return a.promise},g.prototype.$mapSync=function(){var a=b.defer();return a.promise},g}]);